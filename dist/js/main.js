!function(e){var n={},t={},a={},o={};n.name="view",n.init=function(){n.parseDOM(),n.bind()},n.parseDOM=function(){t=e("#bar,#platform").parseDOM(),t.body=e(document.body),t.bar=e("#bar"),t.platform=e("#platform"),t.body.addClass("right"),t.upload.addClass("show"),n.custEvts.copyLock(),n.custEvts.urlsTextLock()},n.bind=function(){var e,a;e=n.evts.bar;for(var a in e)e.hasOwnProperty(a)&&t.bar.on("click",'[action-type="'+a+'"]',e[a]);e=n.evts.upload;for(var a in e)e.hasOwnProperty(a)&&t.uploadDrop.on(a,e[a]);e=n.evts.uploadBox;for(var a in e)e.hasOwnProperty(a)&&t.uploadBox.on(a,e[a]);e=n.custEvts;for(var a in e)e.hasOwnProperty(a)&&channel.register(n.name,a,e[a])},n.evts={bar:{copyBtn:function(e){return e.preventDefault(),a.copyBtn||o.urls&&o.urls.length&&channel.fire(n.name,"copyAllToClipboard",o.urls.join("\n")),!1},uploadBtn:function(e){return e.preventDefault(),a.uploadBtn||n.showPlat("upload"),!1},urlsTextBtn:function(e){return e.preventDefault(),a.urlsTextBtn||o.urls&&o.urls.length&&n.showPlat("urlsText"),!1},historyBtn:function(e){return e.preventDefault(),n.renderHistory(),!1}},upload:{dragenter:function(e){return e.preventDefault(),!1},dragover:function(e){return e.preventDefault(),!1},dragleave:function(e){return e.preventDefault(),!1},drop:function(e){return e.preventDefault(),channel.fire(n.name,"dropedFiles",e.dataTransfer.files),!1}},uploadBox:{change:function(){channel.fire(n.name,"selectedFiles",t.uploadBox.get(0).files)}}},n.custEvts={closePlat:function(){var e=t.platform.find("li");e.addClass("hide"),window.setTimeout(function(){e.removeClass("hide").removeClass("show")},500)},updateUrlsText:function(e){o.urls=e,t.urlsTextBox.val(e.join("\n"))},uploadLock:function(){a.uploadBtn=!0,t.uploadBtn.addClass("disable")},uploadUnlock:function(){a.uploadBtn=!1,t.uploadBtn.removeClass("disable")},copyLock:function(){a.copyBtn=!0,t.copyBtn.addClass("disable")},copyUnlock:function(){a.copyBtn=!1,t.copyBtn.removeClass("disable")},urlsTextLock:function(){a.urlsTextBtn=!0,t.urlsTextBtn.addClass("disable")},urlsTextUnlock:function(){a.urlsTextBtn=!1,t.urlsTextBtn.removeClass("disable")}},n.showPlat=function(n){var a=t.platform.find('li:not([node-type="'+n+'"])');a.each(function(){var n=e(this);n.hasClass("show")&&(n.addClass("hide"),window.setTimeout(function(){n.removeClass("hide").removeClass("show")},500))}),t.platform.find('[node-type="'+n+'"]').addClass("show")},n.renderHistory=function(){var e=historyManager.load();e.length?(t.historyBox.html(e.reverse().map(function(e){return'<li><div style="background-image:url('+e.src+')"></div></li>'}).join("\n")),n.showPlat("history")):channel.fire("tips","show","没有上传记录")},n.init()}(Zepto),function(e,n){var t={},a={},o=[],l={},r=["image/png","image/jpeg","image/gif","image/bmp"];t.name="uploader",t.init=function(){t.parseDOM(),t.bind()},t.parseDOM=function(){a.body=e(document.body),a.list=e("#list")},t.bind=function(){for(var e in t.custEvts)t.custEvts.hasOwnProperty(e)&&channel.register(t.name,e,t.custEvts[e]);for(var e in t.evts)t.evts.hasOwnProperty(e)&&a.list.on("click",'[action-type="'+e+'"]',t.evts[e])},t.evts={copy:function(n){return n.preventDefault(),t.copyToClipboard(e(this).parents(".preview").data("url")),!1}},t.custEvts={upload:function(e){t.startUpload(e)}},t.getImageList=function(e){for(var n=[],t=0;t<e.length;t++)r.indexOf(e[t].type)>-1&&n.push(e[t]);return n},t.startUpload=function(e){t.resetTaskList(),e=t.getImageList(e),e.length&&(channel.fire(t.name,"uploadStart"),t.createUploadQueue(e))},t.createUploadQueue=function(e){l.status=new Array(e.length).fill("pending"),e.forEach(t.previewTask)},t.uploadQueueCompleteScan=function(){var e=l.status,n=e.filter(function(e){return"rejected"===e?!0:!1}),a=[],r=e.filter(function(e,n){return"resloved"===e?(a.push(o[n].data("url")),!0):!1});e.length===n.length+r.length&&(t.resetTaskList(),channel.fire(t.name,"uploadComplete",[t.getAllUrls()]),channel.fire(t.name,"saveToHistory",[a.map(function(e){return{src:e}})]))},t.previewTask=function(e,n){null==l.preview&&(l.preview=queue(1)),l.preview.defer(function(a){var o=new FileReader;o.onload=function(e){t.createPreview(e.target.result),t.uploadTask(e.target.result,n),a()},o.readAsDataURL(e)})},t.uploadTask=function(e,a){null==l.upload&&(l.upload=queue(3)),l.upload.defer(function(o){t.uploading(a),channel.fire(t.name,"uploadTo",[e,function(e){null!=e?t.uploaded(a,e):t.uploaderr(a),o()}]),l.status[a]=n.setTimeout(function(){t.uploaderr(a),o()},8e3)})},t.createPreview=function(n){var t=e('<li class="preview"><div class="picture" style="background-image:url('+n+')"></div><button action-type="copy" class="fa fa-copy"></button></li>');a.list.append(t),o.push(t)},t.uploading=function(e){o[e].addClass("uploading")},t.uploaderr=function(e){l.status&&"resloved"!==l.status[e]&&(n.clearTimeout(l.status[e]),o[e].addClass("uploaderr"),l.status[e]="rejected",t.uploadQueueCompleteScan())},t.uploaded=function(e,a){if(a&&l.status&&"rejected"!==l.status[e]){n.clearTimeout(l.status[e]);var r=o[e];r.data("url",a);var u=new Image;u.onload=function(){r.addClass("uploaded"),r.find(".picture").css("background-image","url("+a+")"),l.status[e]="resloved",t.uploadQueueCompleteScan()},u.src=a}},t.copyToClipboard=function(e){channel.fire(t.name,"copyToClipboard",e)},t.getAllUrls=function(){var n=[];return a.list.find(".preview").each(function(){n.push(e(this).data("url"))}),n},t.resetTaskList=function(){o=[],l={}},t.init()}(Zepto,this||window),function(){channel.bind(["view","dropedFiles"],["uploader","upload"]),channel.bind(["view","selectedFiles"],["uploader","upload"]),channel.bind(["view","copyAllToClipboard"],["clipboard","copy"]),channel.bind(["uploader","uploadStart"],["view","closePlat"]),channel.bind(["uploader","uploadStart"],["view","uploadLock"]),channel.bind(["uploader","uploadComplete"],["view","uploadUnlock"]),channel.bind(["uploader","uploadStart"],["view","copyLock"]),channel.bind(["uploader","uploadComplete"],["view","copyUnlock"]),channel.bind(["uploader","uploadStart"],["view","urlsTextLock"]),channel.bind(["uploader","uploadComplete"],["view","urlsTextUnlock"]),channel.bind(["uploader","uploadComplete"],["view","updateUrlsText"]),channel.bind(["uploader","copyToClipboard"],["clipboard","copy"]),channel.bind(["uploader","saveToHistory"],["historyManager","add"]),channel.bind(["uploader","uploadTo"],["app_weibo","upload"])}();