!function(e){var a={},n={},t={},o={};a.name="view",a.init=function(){a.parseDOM(),a.bind()},a.parseDOM=function(){n=e("#bar,#platform").parseDOM(),n.body=e(document.body),n.bar=e("#bar"),n.platform=e("#platform"),n.body.addClass("right"),n.upload.addClass("show")},a.bind=function(){var e,t;e=a.evts.bar;for(var t in e)e.hasOwnProperty(t)&&n.bar.on("click",'[action-type="'+t+'"]',e[t]);e=a.evts.upload;for(var t in e)e.hasOwnProperty(t)&&n.uploadDrop.on(t,e[t]);e=a.evts.uploadBox;for(var t in e)e.hasOwnProperty(t)&&n.uploadBox.on(t,e[t]);e=a.custEvts;for(var t in e)e.hasOwnProperty(t)&&channel.register(a.name,t,e[t])},a.evts={bar:{copyAllToClipboard:function(e){return e.preventDefault(),o.urls&&o.urls.length&&channel.fire(a.name,"copyAllToClipboard",o.urls.join("\n")),!1},uploadBtn:function(e){return e.preventDefault(),t.uploadBtn||a.showPlat("upload"),!1},urlsText:function(e){return e.preventDefault(),a.showPlat("urlsText"),!1}},upload:{dragenter:function(e){return e.preventDefault(),!1},dragover:function(e){return e.preventDefault(),!1},dragleave:function(e){return e.preventDefault(),!1},drop:function(e){return e.preventDefault(),channel.fire(a.name,"dropedFiles",e.dataTransfer.files),!1}},uploadBox:{change:function(){channel.fire(a.name,"selectedFiles",n.uploadBox.get(0).files)}}},a.custEvts={closePlat:function(){var e=n.platform.find("li");e.addClass("hide"),window.setTimeout(function(){e.removeClass("hide").removeClass("show")},500)},updateUrlsText:function(e){o.urls=e,n.urlsTextBox.val(e.join("\n"))},uploadLock:function(){t.uploadBtn=!0,n.uploadBtn.addClass("disable")},uploadUnlock:function(){t.uploadBtn=!1,n.uploadBtn.removeClass("disable")}},a.showPlat=function(a){var t=n.platform.find('li:not([node-type="'+a+'"])');t.each(function(){var a=e(this);a.hasClass("show")&&(a.addClass("hide"),window.setTimeout(function(){a.removeClass("hide").removeClass("show")},500))}),n.platform.find('[node-type="'+a+'"]').addClass("show")},a.init()}(Zepto),function(e,a){var n={},t={},o=[],l={};n.name="uploader",n.init=function(){n.parseDOM(),n.bind()},n.parseDOM=function(){t.body=e(document.body),t.list=e("#list")},n.bind=function(){for(var e in n.custEvts)n.custEvts.hasOwnProperty(e)&&channel.register(n.name,e,n.custEvts[e])},n.custEvts={upload:function(e){n.startUpload(e)}},n.getImageList=function(e){for(var a=[],n=0;n<e.length;n++)e[n].type.search(/^image/)>-1&&a.push(e[n]);return a},n.startUpload=function(e){n.resetTaskList(),e=n.getImageList(e),e.length&&(channel.fire(n.name,"uploadStart"),n.createUploadQueue(e))},n.createUploadQueue=function(e){l.status=new Array(e.length).fill("pending"),e.forEach(n.previewTask)},n.uploadQueueCompleteScan=function(){var e=l.status,a=e.filter(function(e){return"rejected"===e?!0:!1}),t=e.filter(function(e){return"resloved"===e?!0:!1});e.length===a.length+t.length&&(n.resetTaskList(),channel.fire(n.name,"uploadComplete",[n.getAllUrls()]))},n.previewTask=function(e,a){null==l.preview&&(l.preview=queue(1)),l.preview.defer(function(t){var o=new FileReader;o.onload=function(e){n.createPreview(e.target.result),n.uploadTask(e.target.result,a),t()},o.readAsDataURL(e)})},n.uploadTask=function(e,t){null==l.upload&&(l.upload=queue(3)),l.upload.defer(function(o){n.uploading(t),channel.fire(n.name,"uploadTo",[e,function(e){null!=e?n.uploaded(t,e):n.uploaderr(t),o()}]),l.status[t]=a.setTimeout(function(){n.uploaderr(t),o()},8e3)})},n.createPreview=function(a){var n=e("<li></li>").addClass("preview"),l=e("<div></div>").addClass("picture");l.css("background-image","url("+a+")"),n.append(l),t.list.append(n),o.push(n)},n.uploading=function(e){o[e].addClass("uploading")},n.uploaderr=function(e){l.status&&"resloved"!==l.status[e]&&(a.clearTimeout(l.status[e]),o[e].addClass("uploaderr"),l.status[e]="rejected",n.uploadQueueCompleteScan())},n.uploaded=function(t,r){if(r&&l.status&&"rejected"!==l.status[t]){a.clearTimeout(l.status[t]);var u=o[t];u.data("url",r);var i=new Image;i.onload=function(){u.addClass("uploaded"),u.find(".picture").css("background-image","url("+r+")");var a=e("<button></button>").addClass("fa fa-copy");a.on("click",function(){var a=e(this);n.copyToClipboard(a.parents(".preview").data("url"))}),u.append(a),l.status[t]="resloved",n.uploadQueueCompleteScan()},i.src=r}},n.copyToClipboard=function(e){channel.fire(n.name,"copyToClipboard",e)},n.getAllUrls=function(){var a=[];return t.list.find(".preview").each(function(){a.push(e(this).data("url"))}),a},n.resetTaskList=function(){o=[],l={}},n.init()}(Zepto,this||window),function(){channel.bind(["view","dropedFiles"],["uploader","upload"]),channel.bind(["view","selectedFiles"],["uploader","upload"]),channel.bind(["view","copyAllToClipboard"],["clipboard","copy"]),channel.bind(["uploader","uploadStart"],["view","closePlat"]),channel.bind(["uploader","uploadStart"],["view","uploadLock"]),channel.bind(["uploader","uploadComplete"],["view","uploadUnlock"]),channel.bind(["uploader","uploadComplete"],["view","updateUrlsText"]),channel.bind(["uploader","copyToClipboard"],["clipboard","copy"]),channel.bind(["uploader","uploadTo"],["app_weibo","upload"]),channel.bind(["app_weibo","error"],["tips","show"]),channel.bind(["clipboard","copySuccessful"],["tips","show"]),channel.bind(["clipboard","copyUnsuccessful"],["tips","show"])}();